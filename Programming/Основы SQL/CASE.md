***
Выражение `CASE` в SQL представляет собой общее условное выражение, напоминающее операторы if/else в других языках программирования:


``` postgresql
CASE WHEN _`условие`_ THEN _`результат`_
     [WHEN ...]
     [ELSE _`результат`_]
END
```


>[!hint]
>Предложения `CASE` можно использовать везде, где допускаются выражения. Каждое _`условие`_ в нём представляет собой выражение, возвращающее результат типа `boolean`. Если результатом выражения оказывается true, значением выражения `CASE` становится _`результат`_, следующий за условием, а остальная часть выражения `CASE` не вычисляется. Если же условие не выполняется, за ним таким же образом проверяются все последующие предложения `WHEN`. Если не выполняется ни одно из _`условий`_ `WHEN`, значением `CASE` становится _`результат`_, записанный в предложении `ELSE`. Если при этом предложение `ELSE` отсутствует, результатом выражения будет NULL.

***

## CASE WHEN <простое условие> THEN <сложный запрос>


В более общей ситуации, когда условие подразумевает не просто проверку на `NULL`, можно **"заизолировать" внутри** [CASE](https://postgrespro.ru/docs/postgresql/14/functions-conditional#FUNCTIONS-CASE) выполнение сложных операций более легко вычислимыми [простыми условиями](https://explain.tensor.ru/archive/explain/d93ddae5daf83e9b1773a4c15d967c27:0:2022-05-26):

```postgresql
SELECT
	CASE
		WHEN random() < 0.5 THEN (SELECT 1)
		WHEN random() < 0.5 THEN (SELECT 2)
		ELSE (SELECT 3)
	END r;
```

***

## CASE <сложный запрос> WHEN <значение>


Если нам необходимо вычислить некоторое значение на основании результата какого-то сложного запроса, то предыдущий вариант уже будет выглядеть не очень хорошо:

``` postgresql
SELECT
	CASE
		WHEN (SELECT ...A) = 1 THEN 'one'
		WHEN (SELECT ...A) = 2 THEN 'two'
		WHEN (SELECT ...A) = 3 THEN 'three'
	END;
```

Однако, если вложенный запрос возвращает значение `3`, то и выполняться он тут будет трижды. Мало того, в некоторых случая (например, при использовании `random()` или любой другой не-`STABLE`-функции) это просто нельзя использовать, поскольку приведет к ошибке.

Тем не менее, если воспользоваться `CASE`-конструкцией проверки значения выражения, можно записать и короче, и правильнее:

``` postgresql
SELECT
	CASE (SELECT ...A)
		WHEN 1 THEN 'one'
		WHEN 2 THEN 'two'
		WHEN 3 THEN 'three'
	END;
```


***
### Источники

- [«Ленивый сахар» PostgreSQL](https://habr.com/ru/companies/tensor/articles/667998/)
